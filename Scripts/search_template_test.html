<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ETOH Tower Search — Reused DOM Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue",
        Arial;
      padding: 16px;
      color: #0b0b0b;
      background: #f7f7fb;
    }
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    input[type="text"] {
      padding: 8px 10px;
      font-size: 14px;
      width: 420px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: white;
    }
    .results {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .row {
      background: white;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #e2e2e8;
      display: flex;
      gap: 12px;
      align-items: center;
      font-family: monospace;
      white-space: pre;
      justify-content: flex-start;
      overflow: hidden;
    }
    .short {
      width: 180px;
      color: #111;
      font-weight: 600;
      flex: 0 0 180px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .fullname {
      width: 540px;
      color: #0b0b0b;
      flex: 0 0 540px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .reasons {
      color: #555;
      font-weight: 500;
      width: 260px;
      flex: 0 0 260px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .score {
      color: #333;
      width: 48px;
      flex: 0 0 48px;
      text-align: right;
    }
    .highlight {
      background: #fffb91;
      border-radius: 3px;
      padding: 0 1px;
    }
    .selected {
      background: #ffd28b;
    }
    footer {
      margin-top: 12px;
      font-size: 12px;
      color: #666;
    }
    .note {
      font-size: 13px;
      color: #444;
    }
  </style>
</head>
<body>
  <h3>ETOH Tower Search — Reused DOM Demo</h3>

  <div class="controls">
    <label>
      Query
      <input id="q" type="text" placeholder="Type query or acronym (e.g. CoWS, ToWER)"/>
    </label>

    <label>
      Min score: <span id="minVal">30</span>
      <input id="minScore" type="range" min="0" max="100" step="1" value="30"/>
    </label>

    <button id="clear">Clear</button>
    <div style="margin-left:8px" class="note">Rows are reused — faster rendering.</div>
  </div>

  <div class="results" id="results" aria-live="polite"></div>

  <footer>Code written by T3 Chat (AI assistant). Demo only.</footer>

  <script>
    // ---------- user-provided highlight_span (kept) ----------
    function highlight_span(span, regex, selected) {
      // user's original behaviour: highlight any character in 'text' (character class)
      //
      // NOTE: THis can be massively improved by **not** getting the text content from the DOM.
      // NOTE: I suspect that this is also slightly slower due to inifficent regex due to at worst replacing every character instead of a bunch of characters.
      span.innerHTML = span.textContent.replaceAll(regex, function (match) {
        return '<span class="highlight ' + (selected ? "selected" : "") +
               '>' + match + "</span>";
      });
      // span.innerHTML = "e";
    }

    // ---------- shortTowerName ----------
    function shortTowerName(tower_name) {
      return tower_name
        .split(/[\s-]/gm)
        .map(function (word) { return word.toLowerCase(); })
        .map(function (word) { return word == "of" || word == "and" ? word[0] : word[0].toUpperCase(); })
        .join("");
    }

    // ---------- user's modified isAcronymQuery (kept) ----------
    function isAcronymQuery(q) {
      let is_acro = q.startsWith("To") || q.startsWith("Co");
      let thirdLetter = q.charAt(2);
      is_acro == is_acro &&
        thirdLetter === thirdLetter.toUpperCase() && thirdLetter !== thirdLetter.toLowerCase();
      return is_acro;
    }

    function isSubsequence(sub, full) {
      var i = 0;
      var j = 0;
      for (; i < sub.length && j < full.length; j++) {
        if (sub[i].toLowerCase() === full[j].toLowerCase()) { i++; }
      }
      return i === sub.length;
    }

    function levenshtein(a, b) {
      var A = a.toLowerCase();
      var B = b.toLowerCase();
      var m = A.length;
      var n = B.length;
      var dp = new Array(m + 1);
      for (var i = 0; i <= m; i++) {
        dp[i] = new Array(n + 1).fill(0);
      }
      for (var ii = 0; ii <= m; ii++) dp[ii][0] = ii;
      for (var jj = 0; jj <= n; jj++) dp[0][jj] = jj;
      for (var i1 = 1; i1 <= m; i1++) {
        for (var j1 = 1; j1 <= n; j1++) {
          var cost = A[i1 - 1] === B[j1 - 1] ? 0 : 1;
          dp[i1][j1] = Math.min(
            dp[i1 - 1][j1] + 1,
            dp[i1][j1 - 1] + 1,
            dp[i1 - 1][j1 - 1] + cost
          );
        }
      }
      return dp[m][n];
    }

    function fuzzyScore(a, b) {
      var distance = levenshtein(a, b);
      var maxLen = Math.max(a.length, b.length, 1);
      return Math.max(0, Math.round((1 - distance / maxLen) * 100));
    }

    // ---------- searchTowers (collects reasons, minScore opt) ----------
    function searchTowers(query, data, opts) {
      opts = opts || {};
      var MIN_SCORE = typeof opts.minScore === "number" ? opts.minScore : 30;
      var q = (query || "").trim();
      var isAcr = isAcronymQuery(q);
      var shortNames = data.map(function (d) { return { name: d, short: shortTowerName(d) }; });
      var scored = shortNames.map(function (item) {
        var name = item.name;
        var short = item.short;
        var score = 0;
        var reasons = [];
        if (isAcr) {
          var qUpper = q;
          var shortUpper = short;
          if (qUpper === shortUpper) { score = Math.max(score, 100); reasons.push("exact acronym"); }
          if (shortUpper.startsWith(qUpper)) { score = Math.max(score, 80); reasons.push("acronym prefix"); }
          if (isSubsequence(qUpper, shortUpper)) { score = Math.max(score, 60); reasons.push("acronym subsequence"); }
          var fs = fuzzyScore(qUpper, shortUpper);
          var fsScore = Math.round(fs * 0.6);
          score = Math.max(score, fsScore);
          reasons.push("acronym fuzzy:" + fs);
        }
        if (!isAcr) {
          var lowerName = name.toLowerCase();
          var ql = q.toLowerCase();
          if (lowerName === ql) { score = Math.max(score, 100); reasons.push("exact name"); }
          if (lowerName.startsWith(ql)) { score = Math.max(score, 70); reasons.push("name startsWith"); }
          if (lowerName.includes(ql)) { score = Math.max(score, 50); reasons.push("name includes"); }
          var fs2 = fuzzyScore(ql, lowerName);
          score = Math.max(score, fs2);
          reasons.push("name fuzzy:" + fs2);
        }
        return { name: name, short: short, score: score, reasons: reasons };
      });
      return scored
        .filter(function (r) { return r.score >= MIN_SCORE; })
        .sort(function (a, b) { return b.score - a.score || a.name.localeCompare(b.name); });
    }

    // ---------- THE PROVIDED LARGE DATA ARRAY (used as-is) ----------
    var data = [
      "Tower of Overcoming Hatred",
      "Tower of Inner and Outer Scaling",
      "This Is A Tower",
      "Wow! It's A Tower!",
      "Do Dat Look Like A Tower",
      "Tower of Modernistic Design Choices",
      "Tower of Genesis",
      "Tower of Buttons",
      "Tower of Motion Evolution",
      "Tower of Critical Damage",
      "Tower of Kinetic Potential",
      "Tower of No Strings Attached",
      "Tower of Keys To Success",
      "Citadel of Victory",
      "Tower of Dancing All Night",
      "Not Even A Tower",
      "Tower of A Simple Time",
      "Tower of Anger",
      "Tower of Madness",
      "Tower of Noticeable Infuriation",
      "Tower of Hecc",
      "Tower of Killjoys",
      "Tower of Keyboard Yeeting",
      "Tower of Stress",
      "Tower of Screen Punching",
      "Tower of Rage",
      "Tower of Impossible Expectations",
      "Citadel of Laptop Splitting",
      "Tower of True Skill",
      "Tower of Thanos Tower",
      "Maybe A Tower",
      "Tower of Phone Snapping",
      "Tower of Big Hole",
      "Tower of Cold Hands",
      "Tower of Falling and Failing",
      "Tower of Traps",
      "Tower of Deep Darkness",
      "Tower of Shattered Dreams",
      "Tower of Table Flipping",
      "Tower of Eternal Suffering",
      "Citadel of Wacky Strategy",
      "Tower of Difficulty Chart",
      "Tower of Funny Thoughts",
      "Tower of Inverted Colors",
      "Tower of Ancient Trickery",
      "Tower of Deep Sighing",
      "Tower of Fatness",
      "Tower of Winning Every Run",
      "Tower of Slight Inconvenience",
      "Tower of Wall Hugging",
      "Tower of Lotsa Damage",
      "Tower of Despair",
      "Citadel of Heights and Depths",
      "Tower of Confusion",
      "Tower of Spiralling Heights",
      "Tower of Getting Gnomed",
      "Tower of Terrible Mondays",
      "Tower of Elysium",
      "Tower of Linonophobia",
      "Tower of Leaning Ledges",
      "Tower of Dust and Decay",
      "Tower of Holy Flip",
      "Citadel of Uneasiness",
      "Tower of Oblivion",
      "Tower of Nonsensical Platforms",
      "Tower of Corrupted Nightmares",
      "Tower of Vivid Sections",
      "Tower of Inception",
      "Tower of Nice Views",
      "Tower of Trivial Resentment",
      "Tower of Rigid Success",
      "Tower of Downward Mobility",
      "Tower of Obvious Chaos",
      "Tower of Floral Fury",
      "Tower of Extraordinary Adventures",
      "Tower of Tokyo Heights",
      "Tower of Glitching and Healing",
      "Tower of Fractured Obstacles",
      "Citadel of Contrasting Regions",
      "Tower of Icy Blizzards",
      "Tower of Frightening Nightmares",
      "Tower of Friendly Jumps",
      "Tower of Environmental Pain",
      "Tower of Radiant Realms",
      "Tower of Twisted Inquisition",
      "Tower of A Depressing Future",
      "Tower of Intense Solar Chaos",
      "Tower of Dispersed Rooms",
      "Tower of Flustering Sections",
      "Tower of Niflheim",
      "Citadel of Scythe Recognition",
      "Tower of Strategic Mechanics",
      "Tower of Impossible Movement",
      "Tower of Rushed Building",
      "Tower of Collective Collaboration",
      "Tower of Feeling Lazy",
      "Tower of Distorted Aerodynamics",
      "Tower of Orientating Oscillating Opinions",
      "Tower of Never Giving Up, Ever",
      "Tower of Never Ending Dizziness",
      "Tower of Ultraviolet",
      "Citadel of True Exasperation",
      "Tower of Yearning Victory",
      "Tower of Extreme Hell",
      "Tower of Terrifying Beauty",
      "Tower of Elongated Runs",
      "Tower of Somewhat Simple Scaling",
      "Tower of Needing Basic Aptitude",
      "Tower of Voluminous Framework",
      "Tower of Vibrant Adventures",
      "Tower of Aamos' Anger",
      "Citadel of Constant Heart Stopping",
      "Tower of Uneasy Scaling",
      "Tower of Insanely Innovative Ideas",
      "Tower of Verdant Entropy",
      "Tower of Mean Tasks",
      "Tower of Suffering Outside",
      "Tower of Externalizing Insanity",
      "Tower of Generation Failure",
      "Tower of Great Overcomings",
      "Tower of Beat Block Berserk",
      "Tower of Questionable Trials",
      "Citadel of Lethargy",
      "Tower of Pastel Pillars",
      "Tower of High Adrenaline",
      "Tower of Bent Trauma",
      "Tower of Curved Ascent",
      "Tower of Frightening and Confusing Trials",
      "Tower of Bloodthirsty Kenos",
      "Tower of Journey's End",
      "Tower of Nervous Sweating",
      "Tower of Augmented Misery",
      "Tower of Champion's Road",
      "Tower of Cruel Punishment",
      "Steeple of Meaningless Decisions",
      "Tower of Jolly Good Fun",
      "Steeple of Low Woe",
      "Steeple of Pursuit",
      "This Is Probably A Tower",
      "Steeple of Uninstalling Roblox",
      "Tower of Immense Ire",
      "Steeple of Wall Punching",
      "Tower of Versatility",
      "Tower of Triangular Covering",
      "Steeple of Climbing",
      "Steeple of Huge Pain",
      "Tower of Increasing Stress",
      "Tower of Dangerous Expeditions",
      "Citadel of Weird Nostalgia",
      "Steeple of Towering Pillars",
      "Tower of Mind Breaking",
      "Steeple of Beginner's Journey",
      "Steeple of Devil's Snare",
      "Steeple of Infectious Foliage",
      "Steeple of Overgrowth",
      "Steeple of Nightfall",
      "Steeple of Overgrown Ascension",
      "Steeple of Greenhouse Placidity",
      "Steeple of Feudal Foliage",
      "Steeple of Lost In Quiescence",
      "Citadel of Biotech Genesis",
      "Steeple of Various Vivariums",
      "Steeple of Flourishing Wastelands",
      "Not Even A Flower",
      "Tower of Perilous Antipode",
      "Steeple of Buoyant Automations",
      "Steeple of Resort In Stasis",
      "Steeple of Ruinous Abate",
      "Tower of Ancestral Interference",
      "Steeple of Descendance",
      "Tower of There Is No Tower",
      "Steeple of Guiding Lights",
      "Steeple of Xenial Abyss",
      "Steeple of Wicked Grotto",
      "Tower of Shallow Waters",
      "Steeple of Involuntary Isolation",
      "Tower of Tenebrous Depths",
      "Steeple of Midnight Acropolis",
      "Steeple of Malignant Blight",
      "Tower of Excessive Weirdness",
      "Tower of Two Sided Troubles",
      "Citadel of Inside Situations",
      "Tower of Losing Our Zeal",
      "Tower of Diverging Layers",
      "Tower of Odd Odyssey",
      "Tower of Witchcraft and Wizardry",
      "Tower of Compact Spaces",
      "Tower of Tallying Every Mistake",
      "Tower of Triple Jeopardy",
      "Tower of Unsettling Heights",
      "Tower of Fruity Zeal",
      "Tower of Viaduct Traversing",
      "Tower of Corner Wedge Climbing",
      "Tower of Wanting More Time",
      "Tower of Shadowy Radiance",
      "Tower of Whisking It All",
      "Tower of Whirl of Winds",
      "Tower of Largely Limited Luminance",
      "Tower of Climactic Beats",
      "Tower of Rhythm Heaven",
      "Tower of Mechanical Disarray",
      "Tower of Wicked Fortress",
      "Tower of Lethean Recollection",
      "Tower of You're Late For Work",
      "Tower of Pursuit Led Astray",
      "Steeple of After-Life Detention",
      "Steeple of Balloon Commune",
      "Steeple of Two Minute Noodles",
      "Steeple of The Manufactured Monstrosity",
      "Tower of The Umbrella, The User",
      "Tower of Infiltrated Ruins",
      "Steeple of Itsy Bitsy",
      "Tower of A Disillusioned Existence",
      "Tower of Warranted Retribution",
      "Tower of Fleeing From Everything Ending",
      "Tower of House Without Home",
      "Steeple of Forlorn Blizzard",
      "Steeple of Cheesy Vengeance",
      "Tower of Zero Disturbances",
      "Tower of Peaceful Happiness and Tranquility",
      "Tower of Atlantic Depths",
      "Tower of Peace",
      "Tower of Hands Sweating",
      "Tower of Mirrored Hecc",
      "Tower of Contractual Obligations",
      "Tower of Yearning Success",
      "Tower of Absolute Vexation",
      "Tower of Wanting Extra Levels",
      "Tower of Ultimately Terrifying",
      "Tower of Extreme Dystopia",
      "Tower of Really Nasty Ideas",
      "Citadel of Peril",
      "Tower of Zespluz",
      "Tower of Thinning Layers",
      "Tower of Venomous Resonance",
      "Tower of Slanted Anticipation",
      "Tower of Ground Level Ascension",
      "Tower of Troublesome Adventures",
      "Tower of Unearthed Discoveries",
      "Tower of Dreams and Caverns",
      "Tower of Pleasant Fantasies",
      "Tower of Slipping and Sliding",
      "Citadel of Green Stuff",
      "Tower of Extraterrestrial Enchantment",
      "Tower of Arcanium Zenturing",
      "Tower of Triangular Terror",
      "Tower of Great Displeasure",
      "Tower of Chaotic Moments",
      "Tower of Double Trouble",
      "Tower of Six Feet Under",
      "Tower of Overestimating Difficulty",
      "Tower of Broken Bricks",
      "Tower of Client Object Frenzy",
      "Tower of Cracked, Crushed Cubes",
      "Tower of Xanthophobia",
      "Tower of Dimensional Hopping",
      "Tower of Mild Agitation",
      "Tower of Cogs and Steam",
      "Tower of Requiring Critical Help",
      "Citadel of Tricky Situations",
      "Tower of Menacing Creations",
      "Tower of Quirky Contraptions",
      "Tower of Infuriating Obstacles",
      "Tower of Cruel and Unusual Punishment",
      "Tower of Hopeless Hell",
      "Tower of Fairly Simple Challenges",
      "Tower of Aquatic Contemplation",
      "Tower of Fun and Simple Trials",
      "Tower of Up Is Down",
      "Tower of Wicked Wedges",
      "Tower of Elevator Travelling",
      "Tower of Pure Chroma",
      "Tower of Mechanically Induced Mayhem",
      "Tower of Shifting Slopes",
      "Tower of Dance Dance Destruction",
      "Tower of Funky Grooves",
      "Citadel of Quadrilaterals",
      "Tower of Tornado Vehemence",
      "Tower of Inevitable Failure",
      "Tower of Sovereign Traveling",
      "Tower of Super Stupid Security Systems",
      "Tower of Fractal Volution",
      "Tower of Bright Serenity",
      "Tower of Stairs To Spare",
      "Tower of Unhealthy Escalation",
      "Tower of Heiwana Kaze",
      "Tower of Horrifying Experiences",
      "Tower of Guided Trials",
      "Citadel of Corporate Enterprise",
      "Tower of Anticlimactic Outcomes",
      "Tower of Brutal and Bizarre Torment",
      "Tower of Zany Architecture",
      "Tower of Polychromatic Zero",
      "Tower of Alien Radiance",
      "Tower of Foreign Domains",
      "Tower of Rock Climbing",
      "Tower of Conflicting Frontiers",
      "Tower of Break It, Buy It",
      "Tower of Angled Scenery",
      "Tower of Hefty Magnitude",
      "Citadel of Twists and Weirdness",
      "Tower of Hazardous Laddering",
      "Tower of Watts",
      "Tower of Astral Fusion",
      "Tower of Massive Overheating",
      "Tower of Brief Challenges",
      "Tower of The Dripping Amalgam",
      "Tower of Micro Management",
      "Tower of Jazz",
      "Tower of Rough Waters",
      "Tower of Sweet Victory",
      "Tower of Bygone Relic",
      "Tower of Destructive Fever",
      "Tower of Growing Madness",
      "Tower of Cylindrical Extensions",
      "Tower of White Space",
      "Tower of Yore",
      "Tower of Cone Mesh Climbing",
      "Tower of Swift and Precise Sections",
      "Tower of Uncontrollable Ire",
      "Citadel of A Cruel Tale",
      "Tower of Fractured Memories",
      "Tower of Uncanny Agony",
      "Tower of Melons In Time",
      "Tower of Cosmic Tides",
      "Tower of A Tetromino Disaster",
      "Tower of X Madness",
      "Tower of Galactic Voyage",
      "Tower of Flame Restoration",
      "Tower of One Nine",
      "Tower of Never Ending Fun",
      "Tower of Manic Lows",
      "Tower of Overbearing Vertigo",
      "Citadel of Pyramid Escapades",
      "Tower of Time and Space Manipulation",
      "Tower of No Return",
      "Tower of Rough Endoplasmic Reticulum",
      "Tower of Astral Eclipse",
      "Tower of Descent Into Exile",
      "Tower of Arrantly Bodeful Cavern Depths",
      "Tower of Dusk To Dawn",
      "Tower of Latest Sensation",
      "Tower of Bonus Level",
      "Tower of Sugar Rush Deluxe",
      "Tower of Nothing New",
      "Tower of Furious Chicken Brawl",
      "Tower of Falling Up",
      "Tower of Eye Candy",
      "Tower of Big Blocky Beefy Buttons",
      "Tower of Minus Facility",
      "Citadel of Increasing Claustrophobia",
      "Tower of Voyaging Into The Earth",
      "Tower of Hollow Reformations",
      "Tower of Panelling Barricades",
      "Tower of Wildly Wacky Wonders",
      "Tower of Empty Meaningless Patterns",
      "Tower of Clandestine Zones",
      "Tower of Resonant Landscapes",
      "Tower of Interstellar Terrarium",
      "Tower of Valiant Verges",
      "Tower of Expecting The Unexpected",
      "Tower of Mach Nine",
      "Tower of One Two Three Four",
      "Tower of The Despondent Fortress",
      "Tower of Prismatic Instability",
      "Tower of Power Laws",
      "Tower of Rain on My World",
      "Tower of Tee Hee Time",
      "Tower of Blast Power",
      "Tower of Complexity and Volatility",
      "Tower of Raging Tempest",
      "Steeple of Biome Traversing",
      "Steeple of Astounding Sorcery",
      "Steeple of Realm Odyssey",
      "Steeple of Atmospheric Powers",
      "Steeple of Twisted Crystals",
      "Steeple of Magical Elements",
      "Steeple of Crystal Ascension",
      "Steeple of Witch Calamity",
      "Steeple of Magical Collaborations",
      "Tower of Icy Adventures",
      "Possibly A Tower",
      "Steeple of Mystical Marine",
      "Steeple of Abyssal Upturn",
      "Steeple of Sunny Island Shenanigans",
      "Steeple of Aquatic Rallies",
      "Steeple of Hallucinatory Spectacles",
      "Steeple of Desolate Isles",
      "Tower of Cyclonic Isles",
      "Steeple of Upright Cliffs",
      "Steeple of Cliffside Falls",
      "Tower of Traversing The Tropics",
      "Steeple of Underlying Breezes",
      "Steeple of Dusty Dunes",
      "Tower of Annoyingly Simple Trials",
      "Tower of Vesi Leikki",
      "Tower of Another Beginning",
      "Tower of Autumn Harvest",
      "Tower of Insult To Injury",
      "Tower of Generation Retro",
      "Tower of Quick, Brown Fox!",
      "Tower of Sparkling Rainbow Water",
      "Tower of One Equals Zero"
    ];

    // ---------- DOM reuse pool ----------
    var resultsEl = document.getElementById("results");
    var rowPool = []; // {rowEl, shortEl, fullEl, reasonsEl, scoreEl}

    function makeRow() {
      var row = document.createElement("div");
      row.className = "row";

      var scoreEl = document.createElement("div");
      scoreEl.className = "score";
      scoreEl.innerText = "";

      var shortEl = document.createElement("div");
      shortEl.className = "short";
      shortEl.innerText = "";

      var fullEl = document.createElement("div");
      fullEl.className = "fullname";
      fullEl.innerText = "";

      var reasonsEl = document.createElement("div");
      reasonsEl.className = "reasons";
      reasonsEl.innerText = "";

      row.appendChild(scoreEl);
      row.appendChild(shortEl);
      row.appendChild(fullEl);
      row.appendChild(reasonsEl);

      resultsEl.appendChild(row);
      var obj = { rowEl: row, scoreEl: scoreEl, shortEl: shortEl, fullEl: fullEl, reasonsEl: reasonsEl };
      rowPool.push(obj);
      return obj;
    }

    // ensure initial small pool
    for (var i = 0; i < 20; i++) makeRow();

    // ---------- UI wiring ----------
    var qInput = document.getElementById("q");
    var minSlider = document.getElementById("minScore");
    var minVal = document.getElementById("minVal");
    var clearBtn = document.getElementById("clear");

    function render() {
      console.time();
      var query = qInput.value || "";
      var min = parseInt(minSlider.value, 10);
      minVal.innerText = String(min);
      var out = searchTowers(query, data, { minScore: min });
      console.timeStamp("Out towers receieved");
      var regex = new RegExp("[" + query + "]", "gi");

      // ensure pool big enough
      if (rowPool.length < out.length) {
        var need = out.length - rowPool.length;
        for (var k = 0; k < need; k++) makeRow();
      }

      // update visible rows
      for (var i = 0; i < rowPool.length; i++) {
        var slot = rowPool[i];
        if (i < out.length) {
          var r = out[i];
          slot.rowEl.style.display = "flex";
          slot.scoreEl.innerText = String(r.score).padStart(3, ' ');
          // set innerText then call highlight to avoid stale innerHTML interfering
          slot.shortEl.innerText = r.short;
          slot.fullEl.innerText = r.name;
          slot.reasonsEl.innerText = "-> " + r.reasons.join(", ");

          // var textToHighlight = isAcronymQuery(query) ? query : query.trim();
          if (query.length > 0) {
            try {
              highlight_span(slot.shortEl, regex, false);
              highlight_span(slot.fullEl, regex, false);
            } catch (e) {
              // highlight failed; fallback to plain text
              slot.shortEl.innerText = r.short;
              slot.fullEl.innerText = r.name;
            }
          }
        } else {
          // hide unused
          slot.rowEl.style.display = "none";
        }
      }

      if (out.length === 0) {
        // show a single informative row (reuse first slot)
        var infoSlot = rowPool[0];
        infoSlot.rowEl.style.display = "flex";
        infoSlot.scoreEl.innerText = "";
        infoSlot.shortEl.innerText = "";
        infoSlot.fullEl.innerText = "No results (try lowering min score or changing query).";
        infoSlot.reasonsEl.innerText = "";
        // hide others
        for (var j = 1; j < rowPool.length; j++) rowPool[j].rowEl.style.display = "none";
      }
      console.timeEnd();
    }

    qInput.addEventListener("input", debounce(render, 120));
    minSlider.addEventListener("input", render);
    clearBtn.addEventListener("click", function () { qInput.value = ""; render(); });

    // expose for console
    window.searchTowers = searchTowers;
    window.shortTowerName = shortTowerName;
    window.towerData = data;

    // initial render
    render();

    // ---------- tiny debounce helper ----------
    function debounce(fn, wait) {
      var t;
      return function () {
        var args = arguments;
        clearTimeout(t);
        t = setTimeout(function () { fn.apply(null, args); }, wait);
      };
    }
  </script>
</body>
</html>
